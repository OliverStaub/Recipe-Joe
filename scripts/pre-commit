#!/bin/bash

# Pre-commit hook for RecipeJoe
# Runs both unit tests and UI tests before allowing commits
# Only runs on main and develop branches (skips feature branches)
# Use 'git commit --no-verify' to bypass this hook if needed

set -e

# Check current branch - only run tests on main and develop
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [[ "$CURRENT_BRANCH" != "main" && "$CURRENT_BRANCH" != "develop" ]]; then
    echo "‚è≠Ô∏è  Skipping pre-commit tests on branch '$CURRENT_BRANCH'"
    echo "   Tests only run on 'main' and 'develop' branches."
    exit 0
fi

echo "üß™ Running pre-commit tests..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the project root directory (repository root)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Check if we can find the xcodeproj
XCODE_PROJECT="RecipeJoe.xcodeproj"
if [ ! -d "$XCODE_PROJECT" ]; then
    echo -e "${RED}‚ùå Could not find $XCODE_PROJECT${NC}"
    exit 1
fi

# Function to run tests
run_tests() {
    local scheme=$1
    local test_type=$2
    local test_target=$3

    echo -e "${YELLOW}Running $test_type...${NC}"
    echo ""

    # Run xcodebuild with fail-fast: stop on first test failure
    # -test-timeouts-enabled YES: Enable test timeouts
    # We run without parallel testing for more predictable results
    local exit_code=0

    # Run xcodebuild, monitoring for failures to stop early
    if [ -n "$test_target" ]; then
        xcodebuild test \
            -project "$XCODE_PROJECT" \
            -scheme "$scheme" \
            -destination 'platform=iOS Simulator,name=iPhone Air' \
            -only-testing:"$test_target" \
            -parallel-testing-enabled NO \
            -test-timeouts-enabled YES 2>&1 | while IFS= read -r line; do
            echo "$line"
            # Check for test failure and exit early
            if echo "$line" | grep -q "failed ("; then
                echo ""
                echo -e "${RED}‚ùå Test failure detected - stopping immediately${NC}"
                pkill -f "xcodebuild.*$scheme" 2>/dev/null || true
                exit 1
            fi
        done
        exit_code=${PIPESTATUS[0]}
    else
        xcodebuild test \
            -project "$XCODE_PROJECT" \
            -scheme "$scheme" \
            -destination 'platform=iOS Simulator,name=iPhone Air' \
            -parallel-testing-enabled NO \
            -test-timeouts-enabled YES 2>&1 | while IFS= read -r line; do
            echo "$line"
            # Check for test failure and exit early
            if echo "$line" | grep -q "failed ("; then
                echo ""
                echo -e "${RED}‚ùå Test failure detected - stopping immediately${NC}"
                pkill -f "xcodebuild.*$scheme" 2>/dev/null || true
                exit 1
            fi
        done
        exit_code=${PIPESTATUS[0]}
    fi

    echo ""

    # Check if xcodebuild succeeded
    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}‚úì $test_type passed${NC}"
        echo ""
        return 0
    else
        echo -e "${RED}‚úó $test_type failed${NC}"
        echo ""
        return 1
    fi
}

# Run Edge Function unit tests (if Deno is installed)
if command -v deno &> /dev/null; then
    echo -e "${YELLOW}Running Edge Function unit tests...${NC}"
    if "$PROJECT_ROOT/scripts/run-edge-tests.sh" unit; then
        echo -e "${GREEN}‚úì Edge Function unit tests passed${NC}"
        echo ""
    else
        echo -e "${RED}‚ùå Edge Function unit tests failed. Commit aborted.${NC}"
        echo -e "${YELLOW}Tip: Use 'git commit --no-verify' to bypass this check${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}‚è≠Ô∏è  Skipping Edge Function tests (Deno not installed)${NC}"
    echo ""
fi

# Run unit tests
if ! run_tests "RecipeJoe" "Unit Tests" "RecipeJoeTests"; then
    echo -e "${RED}‚ùå Unit tests failed. Commit aborted.${NC}"
    echo -e "${YELLOW}Tip: Use 'git commit --no-verify' to bypass this check${NC}"
    exit 1
fi

# Run UI tests
if ! run_tests "RecipeJoe" "UI Tests" "RecipeJoeUITests"; then
    echo -e "${RED}‚ùå UI tests failed. Commit aborted.${NC}"
    echo -e "${YELLOW}Tip: Use 'git commit --no-verify' to bypass this check${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ All tests passed! Proceeding with commit...${NC}"
echo ""

exit 0
